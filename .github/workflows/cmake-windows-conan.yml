name: Build with Conan

on: [push, pull_request]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-2022, ubuntu-22.04, macos-13]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Python (required for Conan)
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install Conan(python -m pip install conan)
      run: |
        pip install conan
        conan --version
        
    - name: Create build directory
      run: mkdir build

    - name: Install dependencies with Conan(python -m conan)
      working-directory: build
      run: |
        conan profile detect --force
        conan install .. --output-folder=. --build=missing

    - name: Configure with CMake (Windows)
      if: runner.os == 'Windows'
      working-directory: build
      run: cmake .. -G "Visual Studio 17 2022" -A x64

    - name: Configure with CMake (Linux/macOS)
      if: runner.os != 'Windows'
      working-directory: build
      run: cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_TOOLCHAIN_FILE=conan_toolchain.cmake -DCMAKE_POLICY_DEFAULT_CMP0091=NEW

    - name: Build project
      working-directory: build
      run: cmake --build . --config Release