name: ubuntu-latest-cache

on:
 # push:
 #   branches: [ "main" ]
 # pull_request:
 #   branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [ubuntu-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Python (required for Conan)
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install uuid-dev
    
    - name: Install latest CMake
      run: |
        pip install cmake --upgrade
        cmake --version    

    - name: Install Conan, ccache and GCC 13 (C++20 compatible)
        run: |
          # 更新包列表
          sudo apt update -y
          # 安装GCC 12（完整支持C++20）、ccache、python-pip
          sudo apt install -y ccache gcc-13 g++-13 python3-pip
          # 配置GCC 12为默认编译器（避免系统默认gcc版本过低）
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 100
          # 验证GCC版本
          gcc --version
          g++ --version
          
          # 配置ccache环境变量（无修改）
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=500M" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          
          # 配置Conan：切换为GCC（核心修改1）
          conan profile new default --detect || true
          conan profile update settings.compiler=gcc default          # 编译器改为gcc
          conan profile update settings.compiler.version=12 default   # GCC版本12
          conan profile update settings.compiler.libcxx=libstdc++11 default # GCC仅用libstdc++11
          conan profile update settings.compiler.cppstd=20 default    # 保持C++20不变

      - name: Cache Conan dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.conan2
            ./conan-cache
          key: ${{ runner.os }}-conan-cpp20-gcc12-${{ hashFiles('**/conanfile.txt', '**/conanfile.py') }}
          restore-keys: |
            ${{ runner.os }}-conan-cpp20-gcc12-

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ${{ runner.os }}-ccache-cpp20-gcc12-${{ hashFiles('**/CMakeLists.txt', '**/*.cpp', '**/*.h') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-cpp20-gcc12-${{ hashFiles('**/CMakeLists.txt', '**/*.cpp', '**/*.h') }}-

      - name: Install dependencies via Conan
        run: |
          mkdir -p build && cd build
          conan install .. --output-folder=. --build=missing
      - name: Create build directory  
        run: |
          mkdir build    

      - name: Install dependencies with Conan(python -m conan)
        run: |
          conan profile detect --force
          conan install . -s build_type=Release -s compiler.cppstd=20 --build=missing
          cmake --preset conan-release
      
      - name: Build project with C++20 (GCC)
        working-directory: build/Release
        run: |
          cmake --build . 
          # 打印ccache统计信息
          ccache -s