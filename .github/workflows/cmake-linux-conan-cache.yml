name: C++ CI with Conan Cache (Fixed)

on:
 # push:
 #   branches: [ "main" ]
 # pull_request:
 #   branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
        
    # GitHub 的 ubuntu-latest 通常预装了 Python，但这一步确保环境干净且版本明确
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install GCC 13
      run: |
       sudo apt-get update
        sudo apt-get install -y software-properties-common
        sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
        sudo apt-get update
        sudo apt-get install -y gcc-13 g++-13
        
    # 这是官方推荐的方式，简单可靠
    - name: Install Conan
      run: |
        python -m pip install --upgrade pip
        pip install conan
        # 验证版本
        conan --version

    # 配置 Conan 缓存 (Actions Cache)
    # Conan 2.x 默认缓存路径是 ~/.conan2
    - name: Cache Conan Packages
      id: cache-conan
      uses: actions/cache@v4
      with:
        path: ~/.conan2
        # Key 基于 lockfile 或 conanfile
        key: ${{ runner.os }}-conan-${{ hashFiles('**/conan.lock') }}-${{ hashFiles('**/conanfile.txt', '**/conanfile.py') }}
        restore-keys: |
          ${{ runner.os }}-conan-${{ hashFiles('**/conan.lock') }}
          ${{ runner.os }}-conan-

    # 缓存编译中间文件 (ccache)
    - name: Cache CCache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-ccache-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-ccache-

    - name: Install ccache
      run: sudo apt-get update && sudo apt-get install -y ccache

    - name: Configure ccache
      run: |
        # 使用环境变量设置最大大小，兼容性最好
        export CCACHE_MAXSIZE=500M
        # 显示当前配置确认生效
        ccache --show-config
        # 显示统计信息（此时应为空）
        ccache --show-stats

    # 安装依赖
    - name: Install Dependencies
      run: |
        # 如果是第一次运行，这会下载并构建包，然后存入缓存
        # 后续运行如果 Key 命中，这里会瞬间完成
        mkdir build
        conan profile detect --force
        conan install . -s build_type=Release -s compiler.cppstd=20 --build=missing
        cmake --preset conan-release

    # 构建项目
    - name: Build
      run: |
       working-directory: build/Release
       run: cmake --build . 