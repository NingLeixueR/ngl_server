name: ubuntu-latest-cache

on:
 # push:
 #   branches: [ "main" ]
 # pull_request:
 #   branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [ubuntu-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Conan
      uses: conan-io/conan-action@v2  # 自动安装最新稳定版 Conan 2.x
    
    
    # 配置 Conan 缓存 (Actions Cache)
    # Conan 2.x 默认缓存路径是 ~/.conan2
    - name: Cache Conan Packages
      id: cache-conan
      uses: actions/cache@v4
      with:
        path: ~/.conan2
        # Key 基于 lockfile (推荐) 或 conanfile。如果 lockfile 存在则优先使用它，因为它更精确。
        key: ${{ runner.os }}-conan-${{ hashFiles('**/conan.lock') }}-${{ hashFiles('**/conanfile.txt', '**/conanfile.py') }}
        restore-keys: |
          ${{ runner.os }}-conan-${{ hashFiles('**/conan.lock') }}
          ${{ runner.os }}-conan-
    
    # 这需要你在 CMake 或 Makefile 中配置使用 ccache
    - name: Cache CCache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-ccache-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-ccache-
          
    # 4. 安装 ccache 工具 (如果镜像未预装)
    - name: Install ccache
      run: sudo apt-get update && sudo apt-get install -y ccache
     
    # 5. 配置 ccache (设置最大大小等)
    - name: Configure ccache
      run: |
        ccache --set-config=maxsize=500M
        ccache --show-stats
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install uuid-dev 
   
    - name: Cache Conan dependencies
      uses: actions/cache@v4
        with:
          path: |
            ~/.conan2
            ./conan-cache
          key: ${{ runner.os }}-conan-cpp20-gcc12-${{ hashFiles('**/conanfile.txt', '**/conanfile.py') }}
          restore-keys: |
            ${{ runner.os }}-conan-cpp20-gcc12-

    - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ${{ runner.os }}-ccache-cpp20-gcc12-${{ hashFiles('**/CMakeLists.txt', '**/*.cpp', '**/*.h') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-cpp20-gcc12-${{ hashFiles('**/CMakeLists.txt', '**/*.cpp', '**/*.h') }}-

    - name: Install dependencies via Conan
        run: |
          mkdir -p build && cd build
          conan install .. --output-folder=. --build=missing
          
    - name: Create build directory  
        run: |
          mkdir build    

    - name: Install dependencies with Conan(python -m conan)
        run: |
          conan profile detect --force
          conan install . -s build_type=Release -s compiler.cppstd=20 --build=missing
          cmake --preset conan-release
      
    - name: Build project with C++20 (GCC)
        working-directory: build/Release
        run: |
          cmake --build . 
          # 打印ccache统计信息
          ccache -s