name: ubuntu-latest

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [ubuntu-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Python (required for Conan)
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        # 移除 cache: pip，因为本项目没有 requirements.txt，避免报错
        # 安装 conan 和 cmake 很快，不需要专门缓存 pip 包

    - name: Install GCC 13
      run: |
        sudo apt-get update
        sudo apt-get install -y software-properties-common
        sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
        sudo apt-get update
        sudo apt-get install -y gcc-13 g++-13
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install uuid-dev
    
    - name: Install latest CMake
      run: |
        pip install cmake --upgrade
        cmake --version
    

    - name: Install Conan
      run: |
        pip install conan
        conan --version
        
    # --- 核心修改：缓存 Conan 数据和构建目录 ---
    - name: Cache Conan and Build artifacts
      uses: actions/cache@v4
      id: cache-conan-build
      with:
        # 缓存 Conan 2.x 的主目录 (包含下载的包和编译好的二进制)
        # 缓存 build 目录以加速增量编译
        path: |
          ~/.conan2
          build
        # 缓存键：基于操作系统 + conanfile 和 CMakeLists 的哈希
        # 如果这些文件没变，直接恢复缓存
        key: ${{ runner.os }}-gcc13-conan-${{ hashFiles('**/conanfile.txt', '**/conanfile.py', '**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-gcc13-conan-

    - name: Create build directory  
      run: |
        mkdir -p build    

    - name: Install dependencies with Conan
      run: |
        # 生成/更新 profile
        conan profile detect --force
        # 安装依赖
        # 如果缓存命中，conan 会直接使用本地包，速度极快
        # --build=missing 确保如果有源码包需要编译，它会执行（但在缓存命中时通常不需要）
        conan install . -s build_type=Release -s compiler.cppstd=20 --build=missing
      
    - name: Configure with CMake
      run: |
        # 如果 build 目录被缓存且有效，CMake 会快速检测并完成配置
        cmake --preset conan-release

    - name: Build project
      working-directory: build/Release
      run: cmake --build . -- -j$(nproc)