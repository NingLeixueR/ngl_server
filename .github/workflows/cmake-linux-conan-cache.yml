name: ubuntu-latest-cache

on:
 # push:
 #   branches: [ "main" ]
 # pull_request:
 #   branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [ubuntu-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Python (required for Conan)
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install uuid-dev
    
    - name: Install latest CMake
      run: |
        pip install cmake --upgrade
        cmake --version    

    - name: Install Conan, ccache and GCC 13 (C++20 compatible)
      run: |
        sudo apt update -y
        sudo apt install -y ccache gcc-13 g++-13 python3-pip
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 100
        gcc --version
        g++ --version
          
        echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
        echo "CCACHE_MAXSIZE=500M" >> $GITHUB_ENV
        echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
        
      - name: Cache Conan dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.conan2
            ./conan-cache
          key: ${{ runner.os }}-conan-cpp20-gcc12-${{ hashFiles('**/conanfile.txt', '**/conanfile.py') }}
          restore-keys: |
            ${{ runner.os }}-conan-cpp20-gcc12-

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ${{ runner.os }}-ccache-cpp20-gcc12-${{ hashFiles('**/CMakeLists.txt', '**/*.cpp', '**/*.h') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-cpp20-gcc12-${{ hashFiles('**/CMakeLists.txt', '**/*.cpp', '**/*.h') }}-

      - name: Install dependencies via Conan
        run: |
          mkdir -p build && cd build
          conan install .. --output-folder=. --build=missing
      - name: Create build directory  
        run: |
          mkdir build    

      - name: Install dependencies with Conan(python -m conan)
        run: |
          conan profile detect --force
          conan install . -s build_type=Release -s compiler.cppstd=20 --build=missing
          cmake --preset conan-release
      
      - name: Build project with C++20 (GCC)
        working-directory: build/Release
        run: |
          cmake --build . 
          # 打印ccache统计信息
          ccache -s